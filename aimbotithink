-- SERVICES --
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UIS = game:GetService("UserInputService")

-- SETTINGS --
getgenv().CameraLockEnabled = false
getgenv().UseTeamCheck = false
getgenv().UseVisibilityCheck = true
getgenv().TargetPartName = "Head" -- change to "HumanoidRootPart" if needed
local maxAngle = 120
local ignoredTeams = {}
local lerpSpeed = 8 -- camera speed

-- HELPER FUNCTIONS --

local function isEnemy(player)
    return not (player.Team == LocalPlayer.Team or table.find(ignoredTeams, player.Team))
end

local function visible(part)
    if not getgenv().UseVisibilityCheck then return true end
    if not (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head")) then return false end
    local origin = LocalPlayer.Character.Head.Position
    local direction = part.Position - origin
    local ray = Ray.new(origin, direction)
    local hit = Workspace:FindPartOnRayWithIgnoreList(ray, {LocalPlayer.Character})
    return hit and hit:IsDescendantOf(part.Parent)
end

local function getTarget()
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
    local hrp = LocalPlayer.Character.HumanoidRootPart
    local camLook = Camera.CFrame.LookVector
    local bestPlayer, bestDot = nil, -1
    local maxDot = math.cos(math.rad(maxAngle))

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local humanoid = player.Character:FindFirstChild("Humanoid")
            local part = player.Character:FindFirstChild(getgenv().TargetPartName)
            if humanoid and humanoid.Health > 0 and part and (not getgenv().UseTeamCheck or isEnemy(player)) and visible(part) then
                local dir = (part.Position - hrp.Position).Unit
                local dot = dir:Dot(camLook)
                if dot > bestDot and dot >= maxDot then
                    bestDot = dot
                    bestPlayer = part
                end
            end
        end
    end

    return bestPlayer
end

-- CAMERA LOCK CONNECTION --
if getgenv().CameraLockConnection then getgenv().CameraLockConnection:Disconnect() end

local lastCFrame = Camera.CFrame
getgenv().CameraLockConnection = RunService.RenderStepped:Connect(function(dt)
    local target = getTarget()
    local current = Camera.CFrame

    if getgenv().CameraLockEnabled and target and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local targetCFrame = CFrame.new(current.Position, target.Position)
        lastCFrame = current:Lerp(targetCFrame, math.clamp(lerpSpeed * dt, 0, 1))
    else
        -- smooth fade-out when no target or disabled
        lastCFrame = current:Lerp(lastCFrame, math.clamp(lerpSpeed * 0.5 * dt, 0, 1))
    end

    Camera.CFrame = lastCFrame
end)

-- GUI CREATION --
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
if PlayerGui:FindFirstChild("CameraLockGui") then PlayerGui.CameraLockGui:Destroy() end

local gui = Instance.new("ScreenGui")
gui.Name = "CameraLockGui"
gui.ResetOnSpawn = false
gui.Parent = PlayerGui

local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0,180,0,60)
toggleButton.Position = UDim2.new(1,-200,0,100)
toggleButton.Text = "AIMBOT: OFF"
toggleButton.Font = Enum.Font.SourceSansLight
toggleButton.TextSize = 22
toggleButton.BackgroundColor3 = Color3.fromRGB(35,35,35)
toggleButton.TextColor3 = Color3.fromRGB(200,200,200)
toggleButton.Parent = gui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0,24)
corner.Parent = toggleButton

toggleButton.MouseEnter:Connect(function() toggleButton.BackgroundColor3 = Color3.fromRGB(55,55,55) end)
toggleButton.MouseLeave:Connect(function() toggleButton.BackgroundColor3 = Color3.fromRGB(35,35,35) end)

toggleButton.MouseButton1Click:Connect(function()
    getgenv().CameraLockEnabled = not getgenv().CameraLockEnabled
    toggleButton.Text = "AIMBOT: " .. (getgenv().CameraLockEnabled and "ON" or "OFF")
end)

-- DRAG FUNCTIONALITY --
local dragging, dragOffset = false, Vector2.new()
local dragBar = Instance.new("Frame", toggleButton)
dragBar.Size = UDim2.new(1,0,0,30)
dragBar.BackgroundTransparency = 1

dragBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragOffset = UIS:GetMouseLocation() - Vector2.new(toggleButton.AbsolutePosition.X, toggleButton.AbsolutePosition.Y)
    end
end)

dragBar.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = false
    end
end)

UIS.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local pos = UIS:GetMouseLocation() - dragOffset
        toggleButton.Position = UDim2.new(0, pos.X, 0, pos.Y)
    end
end)